<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Your Progress on DATA 202</title>
<style>
  :root{ --green:#d9f5d9; --yellow:#fff6cc; --gray:#efefef; --darkgray:#b8b8b8; --bar:#2a6fdb; --bar-bg:#e9eef9; }
  body{ font-family:system-ui, Arial, sans-serif; margin:2rem; }
  .row{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  input[type=text]{ padding:.5rem; min-width:260px; }
  button{ padding:.5rem .8rem; cursor:pointer; }
  #status{ margin-top:.75rem; }
  #results{ margin-top:1rem; max-width:1100px; }
  h1{ margin:.2rem 0 1rem; }
  h2{ margin:1.5rem 0 .25rem; }
  .hdrline{ height:1px; background:#eee; margin:.35rem 0 .5rem; }
  .muted{ color:#666; font-size:.9rem; }
  table{ border-collapse:collapse; width:100%; margin-top:.5rem; }
  th,td{ border:1px solid #ddd; padding:.45rem .55rem; text-align:left; vertical-align:middle; }
  th{ background:#f6f6f6; }
  td.code{ width:90px; font-variant-numeric:tabular-nums; }
  td.mark{ text-align:center; font-weight:600; }
  td.mark.A{ background:var(--green); }
  td.mark.P{ background:var(--yellow); }
  td.mark.N{ background:var(--gray); color:#555; }
  td.mark.NA{ background:var(--darkgray); color:#fff; } /* column not present */
  td.mark.NG{ background:#fff; color:#444; font-style:italic; } /* blank cell -> Not Graded */
  .totals{ margin-top:.5rem; display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; }
  .counts{ font-weight:600; }
  .meter{ position:relative; width:280px; height:12px; background:var(--bar-bg); border-radius:999px; overflow:hidden; }
  .meter .bar{ position:absolute; inset:0 auto 0 0; width:0%; background:var(--bar); border-radius:999px; transition:width .35s ease; }
  .overall{ margin-top:1rem; padding-top:.6rem; border-top:2px solid #000; font-size:1.05rem; display:flex; align-items:center; gap:1rem; flex-wrap:wrap; }
  .error{ color:#b00020; font-weight:600; white-space:pre-wrap; }
  .ok{ color:#0b6a0b; }
</style>
</head>
<body>
  <h1>My Progress on DATA 202</h1>
  <div class="row">
    <input id="key" type="text" placeholder="Enter your keyword" />
    <button id="searchBtn" type="button">Search</button>
  </div>
  <div id="status"></div>
  <div id="results"></div>

<script>
  // ===== CONFIG =====
  const CONFIG = {
    spreadsheetId: "1aTWwSfbTp26CHxWFuMSWwfxgNZKk_YL7oyQMKkTNL7s",
    marksTabName:  "Marks", // Col0 = key. SLO columns begin wherever the first SLO-looking header appears.
    slosTabName:   "SLOs"   // Columns: Code, Description, (optional) Area
  };
  const EXACT_MATCH = true;
  const WEIGHT_PROJECT_X3 = true;
  // ==================

  const statusEl  = document.getElementById('status');
  const resultsEl = document.getElementById('results');
  const keyInput  = document.getElementById('key');

  document.getElementById('searchBtn').addEventListener('click', run);
  keyInput.addEventListener('keydown', e => { if (e.key === 'Enter') run(); });

  // ---- GViz JSONP (bypasses CORS) ----
  function gvizUrl(spreadsheetId, sheet){
    const base = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq`;
    const params = new URLSearchParams({ tqx:'out:json', sheet });
    return `${base}?${params.toString()}`;
  }
  function loadGVizJSONP(url){
    return new Promise((resolve, reject) => {
      const g = (window.google = window.google || {});
      const v = (g.visualization = g.visualization || {});
      const Q = (v.Query = v.Query || {});
      let resolved = false;
      const prev = Q.setResponse;

      Q.setResponse = function(payload){
        try{
          resolved = true;
          Q.setResponse = prev;
          resolve(payload);
        }catch(e){ reject(e); }
        finally{
          if (script && script.parentNode) script.parentNode.removeChild(script);
        }
      };
      const script = document.createElement('script');
      script.src = url;
      script.async = true;
      script.onerror = function(){
        Q.setResponse = prev;
        reject(new Error('Network error loading GViz script (check URL/permissions)'));
      };
      document.head.appendChild(script);

      setTimeout(() => {
        if (!resolved){
          Q.setResponse = prev;
          if (script && script.parentNode) script.parentNode.removeChild(script);
          reject(new Error('GViz timeout: sheet blocked or unexpected response. Is it public to “Anyone with the link”?'));
        }
      }, 15000);
    });
  }

  // ---- Helpers ----
  const cellVal = c => (c == null ? '' : (c.f ?? c.v ?? ''));
  const clean = s => (s||'').toString()
    .replace(/\u00A0/g,' ')
    .replace(/[\u200B-\u200D\uFEFF]/g,'')
    .trim();
  const upperClean = s => clean(s).toUpperCase();
  const prefixToArea = p => ({WRA:'Wrangling', VIS:'Visualization', MOD:'Modeling', PRO:'Project'}[p] || p);

  // Prefer GViz column labels; fallback to first row if labels are empty
  function extractHeaders(table){
    const labels = (table.cols || []).map(c => clean(c && (c.label || c.id || '')));
    if (labels.some(Boolean)) return labels;
    const rows = table.rows || [];
    if (!rows.length) return [];
    return rows[0].c.map(cellVal).map(clean);
  }

  function parseMarks(table){
    const headers = extractHeaders(table);
    const dataRows = (table.rows || []).map(r => r.c.map(cellVal));
    const usedFirstRowAsHeaders = !(table.cols || []).some(c => clean(c && (c.label||'')));
    const students = (usedFirstRowAsHeaders ? dataRows.slice(1) : dataRows)
      .filter(r => r && r.some(x => clean(x) !== ''));
    return { headers, students };
  }

  // Robust SLOs parser:
  // - uses labels if present; otherwise scans the first row
  // - tolerant to variants
  // - NEVER throws; returns {} if not found so the UI still renders
  function parseSLOsTable(table){
    const rows = (table.rows || []).map(r => r.c.map(cellVal));
    const headers = extractHeaders(table);

    const syn = s => clean((s||'').toString()).toLowerCase();
    const hdrLower = headers.map(h => syn(h));

    const codeIdx = hdrLower.findIndex(h =>
      ['code','slo','id','slo code','slo_id','slo id','slo-code'].includes(h)
    );
    const descIdx = hdrLower.findIndex(h =>
      ['description','desc','descrição','descricao'].includes(h)
    );
    const areaIdx = hdrLower.findIndex(h =>
      ['area','category','section','strand'].includes(h)
    );

    if (rows.length < 1){
      console.warn('SLOs tab: GViz returned no rows.');
      return {};
    }

    // If we used labels, GViz has already consumed the first data row
    const startRow = (table.cols || []).some(c => clean(c && c.label)) ? 0 : 1;

    if (codeIdx < 0 || descIdx < 0){
      console.warn('SLOs header not detected; proceeding without descriptions. Headers seen:', headers);
      return {}; // graceful: descriptions will be empty, but SLOs still render
    }

    const map = {};
    rows.slice(startRow).forEach(r => {
      const code = upperClean(r[codeIdx]);
      if (!code) return;
      const areaRaw = areaIdx>=0 ? upperClean(r[areaIdx]) : '';
      map[code] = {
        description: clean(r[descIdx]),
        area: areaRaw ? prefixToArea(areaRaw.slice(0,3)) : null
      };
    });
    return map;
  }

  // Accept headers like WRA01-Q, WRA1Q, VIS 02 – r, MOD10R, PRO03-A, PRO3b
  function parseHeader(h){
    let s = (h || '').toString()
      .replace(/\u00A0/g, ' ')
      .replace(/[\u200B-\u200D\uFEFF]/g, '')
      .replace(/[–—]/g, '-')    // en/em dash -> hyphen
      .replace(/\s+/g, '')
      .toUpperCase();
    const m = s.match(/^([A-Z]{3})(\d{1,2})(?:-?([QRAB]))?$/);
    if (!m) return null;
    const [, pref, numStr, suffRaw] = m;
    const area = prefixToArea(pref);
    const code = pref + numStr.padStart(2, '0');
    let kind = null;
    if (area === 'Project') {
      if (suffRaw === 'A') kind = 'P1 (A)';
      else if (suffRaw === 'B') kind = 'P2 (B)';
      else return null;
    } else {
      if (suffRaw === 'Q') kind = 'Quiz';
      else if (suffRaw === 'R') kind = 'Report';
      else return null;
    }
    return { area, code, kind, num: Number(numStr) };
  }

  function detectSLOStart(headers){
    for (let i = 0; i < headers.length; i++){
      if (parseHeader(headers[i])) return i;
    }
    return -1;
  }

  // Build grouped view; store raw mark (so we can detect NG blank)
  function buildView(headers, row, sloMeta, sloStart){
    const view = {};
    const missing = new Set();

    for (let col = sloStart; col < headers.length; col++){
      const parsed = parseHeader(headers[col]);
      if (!parsed) continue;
      const { area, code, kind, num } = parsed;

      const meta = sloMeta[code];
      if (!meta || !meta.description) missing.add(code);

      const resolvedArea = (meta && meta.area) ? meta.area : area;
      if (!view[resolvedArea]) view[resolvedArea] = {};
      if (!view[resolvedArea][code]) {
        view[resolvedArea][code] = { description: (meta ? meta.description : ''), marks: {}, order: num || 0 };
      }
      view[resolvedArea][code].marks[kind] = (row[col] ?? '').toString(); // raw; may be blank -> NG
    }

    if (missing.size){
      console.warn("Missing SLO descriptions for codes:", Array.from(missing).sort().join(", "));
    }
    return view;
  }

  function meter(pct, label){
    const safe = Math.max(0, Math.min(100, pct));
    return `
      <div class="meter" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${safe}" aria-label="${label}">
        <div class="bar" style="width:${safe}%"></div>
      </div>
      <span class="muted">${safe.toFixed(1)}%</span>
    `;
  }

  // NG (blank) and NA (missing col) are EXCLUDED from totals and mastery %
  function renderSection(area, entries){
    const cols = (area === 'Project') ? ['P1 (A)','P2 (B)'] : ['Quiz','Report'];

    const codes = Object.keys(entries).sort((a,b) => {
      const na = Number(a.slice(3)), nb = Number(b.slice(3));
      if (isNaN(na) || isNaN(nb)) return a.localeCompare(b);
      return na - nb;
    });

    let aCount=0, pCount=0, nCount=0, totalGraded=0; // totals count ONLY A/P/N
    let rowsHtml='';

    codes.forEach(code => {
      const { description, marks } = entries[code];

      const tds = cols.map(label => {
        const raw = marks[label];

        // Column not present → NA (excluded)
        if (typeof raw === 'undefined'){
          return `<td class="mark NA">—</td>`;
        }

        const trimmed = (raw || '').toString().trim();

        // Blank cell → NG (excluded from totals and mastery)
        if (trimmed === ''){
          return `<td class="mark NG">NG</td>`;
        }

        // Graded value (A/P/N). Default to N if unexpected.
        let val = trimmed.toUpperCase();
        if (val !== 'A' && val !== 'P' && val !== 'N') val = 'N';

        if (val==='A') aCount++;
        else if (val==='P') pCount++;
        else nCount++;
        totalGraded++;

        return `<td class="mark ${val}">${val}</td>`;
      }).join('');

      rowsHtml += `<tr><td class="code">${code}</td><td>${escapeHtml(description)}</td>${tds}</tr>`;
    });

    const masteryPct = totalGraded ? ((aCount + 0.5*pCount) / totalGraded * 100) : 0;

    const legend = `<span class="muted">Legend: A=Achieved, P=Progressing, N=Needs work, NG=Not graded (excluded), —=Not applicable (excluded)</span>`;

    return `
      <h2>${area}</h2>
      <div class="hdrline"></div>
      <table>
        <thead>
          <tr><th style="width:90px">SLO</th><th>Description</th><th style="width:110px">${cols[0]}</th><th style="width:110px">${cols[1]}</th></tr>
        </thead>
        <tbody>${rowsHtml}</tbody>
      </table>
      <div class="totals">
        <span class="counts">
          Totals (graded only): A – ${aCount}/${totalGraded}, P – ${pCount}/${totalGraded}, N – ${nCount}/${totalGraded}
        </span>
        ${meter(masteryPct, `${area} mastery`)}
        ${legend}
      </div>
    `;
  }

  function renderAll(view){
    const order = ['Wrangling','Visualization','Modeling','Project'];
    let html = '';
    let numerator = 0, denominator = 0;

    order.forEach(area => {
      if (!view[area]) return;
      html += renderSection(area, view[area]);

      const entries = view[area];
      const cols = (area === 'Project') ? ['P1 (A)','P2 (B)'] : ['Quiz','Report'];
      const w = (WEIGHT_PROJECT_X3 && area === 'Project') ? 3 : 1;

      Object.values(entries).forEach(({marks}) => {
        cols.forEach(label => {
          const raw = marks[label];
          if (typeof raw === 'undefined') return;               // NA → skip
          const trimmed = (raw || '').toString().trim();
          if (trimmed === '') return;                           // NG → skip
          const v = trimmed.toUpperCase();
          numerator   += w * (v === 'A' ? 1 : v === 'P' ? 0.5 : 0);
          denominator += w * 1;
        });
      });
    });

    const overallPct = denominator ? (numerator/denominator*100) : 0;
    html += `
      <div class="overall">
        <div><b>Overall:</b></div>
        ${meter(overallPct, 'Overall mastery')}
      </div>
    `;
    return html;
  }

  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  async function run(){
    const key = keyInput.value.trim();
    statusEl.className = '';
    statusEl.textContent = '';
    resultsEl.innerHTML = '';
    if (!key){ statusEl.className='error'; statusEl.textContent='Enter a keyword to search.'; return; }

    try{
      const marksUrl = gvizUrl(CONFIG.spreadsheetId, CONFIG.marksTabName);
      const slosUrl  = gvizUrl(CONFIG.spreadsheetId, CONFIG.slosTabName);

      statusEl.textContent = 'Loading marks (GViz JSONP)…';
      const marksPayload = await loadGVizJSONP(marksUrl);
      if (!marksPayload || !marksPayload.table) throw new Error('Marks GViz response missing table.');
      const { headers, students } = parseMarks(marksPayload.table);

      const sloStart = detectSLOStart(headers);
      if (sloStart < 0){
        throw new Error('No SLO columns detected in Marks header (expect headers like WRA01-Q, VIS02-R, PRO01-A, etc.).');
      }

      statusEl.textContent = 'Loading SLOs (descriptions optional)…';
      const sloPayload = await loadGVizJSONP(slosUrl);
      const sloMap = (sloPayload && sloPayload.table) ? parseSLOsTable(sloPayload.table) : {};

      // Find student by first column
      const keyLower = key.toLowerCase();
      const matches = students.filter(r => clean(r[0]).toLowerCase() === keyLower);

      if (matches.length === 0){ statusEl.className='error'; statusEl.textContent=`No match for "${key}".`; return; }
      if (matches.length > 1){   statusEl.className='error'; statusEl.textContent=`${matches.length} matches for "${key}".`; return; }

      const row  = matches[0];
      const view = buildView(headers, row, sloMap, sloStart);
      statusEl.className = 'ok';
      statusEl.textContent = `Found 1 match for "${key}".`;
      resultsEl.innerHTML = renderAll(view);

    }catch(e){
      statusEl.className = 'error';
      statusEl.textContent = e.message;
    }
  }
</script>
</body>
</html>
