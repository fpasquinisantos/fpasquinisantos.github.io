/*!
 * The reveal.js markdown plugin. Handles parsing of
 * markdown inside of presentations as well as loading
 * of external markdown documents.
 */
import{marked}from"marked";const DEFAULT_SLIDE_SEPARATOR="\r?\n---\r?\n",DEFAULT_NOTES_SEPARATOR="notes?:",DEFAULT_ELEMENT_ATTRIBUTES_SEPARATOR="\\.element\\s*?(.+?)$",DEFAULT_SLIDE_ATTRIBUTES_SEPARATOR="\\.slide:\\s*?(\\S.+?)$",SCRIPT_END_PLACEHOLDER="__SCRIPT_END__",CODE_LINE_NUMBER_REGEX=/\[([\s\d,|-]*)\]/,HTML_ESCAPE_MAP={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},Plugin=()=>{function t(t){var e=(t.querySelector("[data-template]")||t.querySelector("script")||t).textContent,r=(e=e.replace(new RegExp(SCRIPT_END_PLACEHOLDER,"g"),"</script>")).match(/^\n?(\s*)/)[1].length,a=e.match(/^\n?(\t*)/)[1].length;return a>0?e=e.replace(new RegExp("\\n?\\t{"+a+"}","g"),"\n"):r>1&&(e=e.replace(new RegExp("\\n? {"+r+"}","g"),"\n")),e}function e(t){for(var e=t.attributes,r=[],a=0,n=e.length;a<n;a++){var o=e[a].name,s=e[a].value;/data\-(markdown|separator|vertical|notes)/gi.test(o)||(s?r.push(o+'="'+s+'"'):r.push(o))}return r.join(" ")}function r(t){return(t=t||{}).separator=t.separator||DEFAULT_SLIDE_SEPARATOR,t.notesSeparator=t.notesSeparator||DEFAULT_NOTES_SEPARATOR,t.attributes=t.attributes||"",t}function a(t,e){e=r(e);var a=t.split(new RegExp(e.notesSeparator,"mgi"));return 2===a.length&&(t=a[0]+'<aside class="notes">'+marked(a[1].trim())+"</aside>"),'<script type="text/template">'+(t=t.replace(/<\/script>/g,SCRIPT_END_PLACEHOLDER))+"</script>"}function n(t,e){e=r(e);for(var n,o,s,i=new RegExp(e.separator+(e.verticalSeparator?"|"+e.verticalSeparator:""),"mg"),u=new RegExp(e.separator),d=0,l=!0,c=[];n=i.exec(t);){!(o=u.test(n[0]))&&l&&c.push([]),s=t.substring(d,n.index),o&&l?c.push(s):c[c.length-1].push(s),d=i.lastIndex,l=o}(l?c:c[c.length-1]).push(t.substring(d));for(var E="",p=0,m=c.length;p<m;p++)c[p]instanceof Array?(E+="<section "+e.attributes+">",c[p].forEach(function(t){E+="<section data-markdown>"+a(t,e)+"</section>"}),E+="</section>"):E+="<section "+e.attributes+" data-markdown>"+a(c[p],e)+"</section>";return E}function o(r){return new Promise(function(a){var o=[];[].slice.call(r.querySelectorAll("section[data-markdown]:not([data-markdown-parsed])")).forEach(function(r){r.getAttribute("data-markdown").length?o.push(s(r).then(function(t){r.outerHTML=n(t.responseText,{separator:r.getAttribute("data-separator"),verticalSeparator:r.getAttribute("data-separator-vertical"),notesSeparator:r.getAttribute("data-separator-notes"),attributes:e(r)})},function(t,e){r.outerHTML='<section data-state="alert">ERROR: The attempt to fetch '+e+" failed with HTTP status "+t.status+".Check your browser's JavaScript console for more details.<p>Remember that you need to serve the presentation HTML from a HTTP server.</p></section>"})):r.outerHTML=n(t(r),{separator:r.getAttribute("data-separator"),verticalSeparator:r.getAttribute("data-separator-vertical"),notesSeparator:r.getAttribute("data-separator-notes"),attributes:e(r)})}),Promise.all(o).then(a)})}function s(t){return new Promise(function(e,r){var a=new XMLHttpRequest,n=t.getAttribute("data-markdown"),o=t.getAttribute("data-charset");null!=o&&""!=o&&a.overrideMimeType("text/html; charset="+o),a.onreadystatechange=function(t,a){4===a.readyState&&(a.status>=200&&a.status<300||0===a.status?e(a,n):r(a,n))}.bind(this,t,a),a.open("GET",n,!0);try{a.send()}catch(t){console.warn("Failed to get the Markdown file "+n+". Make sure that the presentation and the file are served by a HTTP server and the file can be found there. "+t),e(a,n)}})}function i(t,e,r){var a,n,o=new RegExp(r,"mg"),s=new RegExp('([^"= ]+?)="([^"]+?)"|(data-[^"= ]+?)(?=[" ])',"mg"),i=t.nodeValue;if(a=o.exec(i)){var u=a[1];for(i=i.substring(0,a.index)+i.substring(o.lastIndex),t.nodeValue=i;n=s.exec(u);)n[2]?e.setAttribute(n[1],n[2]):e.setAttribute(n[3],"");return!0}return!1}function u(t,e,r,a,n){if(null!=e&&null!=e.childNodes&&e.childNodes.length>0)for(var o=e,s=0;s<e.childNodes.length;s++){var d=e.childNodes[s];if(s>0)for(var l=s-1;l>=0;){var c=e.childNodes[l];if("function"==typeof c.setAttribute&&"BR"!=c.tagName){o=c;break}l-=1}var E=t;"section"==d.nodeName&&(E=d,o=d),"function"!=typeof d.setAttribute&&d.nodeType!=Node.COMMENT_NODE||u(E,d,o,a,n)}e.nodeType==Node.COMMENT_NODE&&0==i(e,r,a)&&i(e,t,n)}function d(){var e=c.getRevealElement().querySelectorAll("[data-markdown]:not([data-markdown-parsed])");return[].slice.call(e).forEach(function(e){e.setAttribute("data-markdown-parsed",!0);var r=e.querySelector("aside.notes"),a=t(e);e.innerHTML=marked(a),u(e,e,null,e.getAttribute("data-element-attributes")||e.parentNode.getAttribute("data-element-attributes")||DEFAULT_ELEMENT_ATTRIBUTES_SEPARATOR,e.getAttribute("data-attributes")||e.parentNode.getAttribute("data-attributes")||DEFAULT_SLIDE_ATTRIBUTES_SEPARATOR),r&&e.appendChild(r)}),Promise.resolve()}function l(t){return t.replace(/([&<>'"])/g,t=>HTML_ESCAPE_MAP[t])}let c;return{id:"markdown",init:function(t){c=t;let{renderer:e,animateLists:r,...a}=c.getConfig().markdown||{};return e||(e=new marked.Renderer,e.code=(t,e)=>{let r="";return CODE_LINE_NUMBER_REGEX.test(e)&&(r=e.match(CODE_LINE_NUMBER_REGEX)[1].trim(),r=`data-line-numbers="${r}"`,e=e.replace(CODE_LINE_NUMBER_REGEX,"").trim()),`<pre><code ${r} class="${e}">${t=l(t)}</code></pre>`}),!0===r&&(e.listitem=t=>`<li class="fragment">${t}</li>`),marked.setOptions({renderer:e,...a}),o(c.getRevealElement()).then(d)},processSlides:o,convertSlides:d,slidify:n,marked:marked}};export default Plugin;